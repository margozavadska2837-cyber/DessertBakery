name: CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  cd:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        run: |
          VERSION=v1.0.${{ github.run_number }}
          SHA=sha-${GITHUB_SHA::8}

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SHA=$SHA" >> $GITHUB_ENV

      - name: Build backend image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION} .

      - name: Tag backend image
        run: docker tag ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION} ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${SHA}

      - name: Push backend image
        run: |
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${SHA}

      - name: Save backend TAR
        run: docker save ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION} -o backend.tar

      - name: Build frontend image
        run: docker build -f Dockerfile.frontend -t ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION} .

      - name: Tag frontend image
        run: docker tag ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION} ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${SHA}

      - name: Push frontend image
        run: |
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${SHA}

      - name: Save frontend TAR
        run: docker save ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION} -o frontend.tar

      - name: Build db image
        run: docker build -f db/Dockerfile -t ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION} db

      - name: Tag db image
        run: docker tag ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION} ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${SHA}

      - name: Push db image
        run: |
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${SHA}

      - name: Save db TAR
        run: docker save ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION} -o db.tar

      - name: Upload TAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            backend.tar
            frontend.tar
            db.tar

      - name: Job Summary
        run: |
          echo "## CD Completed" >> $GITHUB_STEP_SUMMARY
          echo "### Published images:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Database: \`ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA tags:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Database: \`${SHA}\`" >> $GITHUB_STEP_SUMMARY
