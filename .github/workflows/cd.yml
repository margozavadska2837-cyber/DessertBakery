name: CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  cd:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    concurrency:
      group: cd-main
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        run: |
          VERSION=v1.0.${{ github.run_number }}
          SHA=sha-${GITHUB_SHA::8}

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SHA=$SHA" >> $GITHUB_ENV

      - name: Build and push backend image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION} .
          docker tag ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION} \
                     ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${SHA}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${SHA}
          docker save ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION} -o backend.tar

      - name: Build and push frontend image
        run: |
          docker build -f Dockerfile.frontend -t ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION} .
          docker tag ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION} \
                     ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${SHA}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${SHA}
          docker save ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION} -o frontend.tar

      - name: Build and push db image
        run: |
          docker build -f db/Dockerfile -t ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION} db
          docker tag ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION} \
                     ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${SHA}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION}
          docker push --quiet ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${SHA}
          docker save ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION} -o db.tar

      - name: Upload TAR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: |
            backend.tar
            frontend.tar
            db.tar

      - name: Job Summary
        run: |
          echo "## CD Completed" >> $GITHUB_STEP_SUMMARY
          echo "### Published images:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`ghcr.io/${{ github.repository_owner }}/dessertbakery-backend:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`ghcr.io/${{ github.repository_owner }}/dessertbakery-frontend:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Database: \`ghcr.io/${{ github.repository_owner }}/dessertbakery-db:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA tags:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Database: \`${SHA}\`" >> $GITHUB_STEP_SUMMARY
